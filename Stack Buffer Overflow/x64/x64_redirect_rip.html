<html>
	<head>
		<link rel="icon" href="https://vulnx.in/favicon.png">
		<script data-ad-client="ca-pub-6203666289882469" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin: 0;}

#myCookieConsent {
    border-radius: 5px;
    border: 5px solid #f44336;
    width: 80%;
    padding: 20px 20px;
    overflow: hidden;
    position: fixed;
    color: #fff;
    bottom: 3px;
    display: none;
    left: 5%;
    text-align: center;
    font-size: 15px;
    font-weight: bold;
}

#myCookieConsent #cookieButton {
    display: inline-block;
    color: #fff;
    font-size: 1.1em;
    background: #000;
    text-decoration: none;
    cursor: pointer;
    padding: 2px 20px;
    float: right;
    border: 2px solid #f44336;
    border-radius: 5px;
    transition: 0.5s;
}
#myCookieConsent #cookieButton:hover {
    border: 2px solid white;
    background: #f44336;
	color: #fff;
}

ul.topnav {
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: #23252e;
}

ul.topnav li {float: left;}

ul.topnav li a {
  background-color: #23252e;
  display: block;
  color: white;
  text-align: center;
  padding: 16px 16px;
  text-decoration: none;
}

ul.topnav li a:hover:not(.active) {background-color: #f44336;}

ul.topnav li a.active {background-color: #4CAF50;}

@media screen and (max-width: 600px) {
  ul.topnav li.left, 
  ul.topnav li {float: none;}
}
</style>
		<link rel="stylesheet" href="style.css"/>
		<link href="https://fonts.googleapis.com/css?family=Fira+Code:600|Lobster&display=swap" rel="stylesheet">
		<title>Buffer Overflow : Part-2. x64_redirect_rip | VulnX</title>

	</head>

	<body>

		<font color="white" face="Fira Code" size="3">	
			<ul class="topnav">
			<li><a href="../../../../../../../../../index.html">Home</a></li>
			<li><a href="../../../../../../../../../Contents/resources.html">Resources</a></li>
			<li><a href="../../../../../../../../../Contents/tutorials.html">Tutorials</a></li>
			<li><a href="../../../../../../../../../Contents/CTFs.html">CTFs</a></li>
			</ul>
		</font>

		<div id="align">
<font color="white" face="Fira Code" size="2">
<div id="myCookieConsent">
	<div id="cookieButton">I agree</div>
	<div>By using our site, you agree to our use of cookies to deliver a better site experience.</div>
</div>

<script>
var obj;
obj = document.getElementById("myCookieConsent");

function  func() {
	obj.style.display = "none";
	document.cookie = "cookiePromptShown=Yes; path=/";
}
var element;
element = document.getElementById("cookieButton");
element.addEventListener('click', func);
</script>
</font>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-167461836-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-167461836-1');
</script>
			
			<font color="white" face="Fira Code" size="2">

				<center><h1>Buffer Overflow</h1></center>
				<center><h1>PART-2 : x64_redirect_rip</h1></center>

				Hello and welcome everybody to the second part of Buffer Overflow series. In the <a href="../../../../../../../../../Stack Buffer Overflow/x86/x86_redirect_eip.html"><font color=#f44336 face="Fira Code Medium" size="2">previous tutorial</font></a> we demonstrated how one can gain control over EIP to redirect execution. That tutorial was based on a modern x86 [ 32-bit ] architecture of linux. Now we will be introducing the same exploit on a modern x64 [ 64-bit ] architecture linux machine.

				<h1><u>STEP 1 - Identification of vulnerability</u></h1>

				In this part the code will be same as the <a href="../../../../../../../../../Stack Buffer Overflow/x86/x86_redirect_eip.html"><font color=#f44336 face="Fira Code Medium" size="2">first part.</font></a><br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x86/images/x86_redirect_eip.c_source.png" class="responsive">
				</div><br>

				From the above code it is clear that as soon as the command to execute the program is issued, the control by default jumps to the main function. In the main function, the control is redirected to the 'vuln' function. In the 'vuln' function, the program allocates a space of 100 bytes for the variable 'buf'. Then it prints a message and waits for the user to supply input to the program. The program takes the input and prints it on the screen. You must have noticed that we are using the 'gets' function to take input. The 'gets' function is dangerous as all it does is that it takes input from the user and stores it in the variable without checking it's length. This way we can overwrite data on the stack if we write more than 100 bytes to the program. Another thing you may have noticed is that the 'call_me' function is created but it is never called. Our goal will be to redirect our execution to the 'call_me' function.<br><br>

				Now in order to start exploiting let's just start by compiling this application for x64 [ 64-bit ]. Use the following command for compilation:<br><br>
				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_compilation_output.png" class="responsive">
				</div><br>

				Now let's test our program using the following command:<br><br>
				
				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_binary_test.png" class="responsive">
				</div><br>

				Okay so the program works flawlessly. Now let's feed it with 150 characters.<br><br>
				
				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_test_with_150_char.png" class="responsive">
				</div><br>

				Alright it causes a seg fault, so now we are sure that there is a chance that we can overwrite the instruction pointer to redirect execution to the 'call_me' function. From the <a href="../../../../../../../../../Stack Buffer Overflow/x86/x86_redirect_eip.html"><font color=#f44336 face="Fira Code Medium" size="2">previous tutorial</font></a>, we are aware that if we overwrite amd change the value of instruction pointer [ RIP, in case of x64 ], to the memory address of the 'call_me' function. We can transfer execution of the program to that memory region. So for that we must get the offset of the RIP, the x64 instruction pointer.

				<h1><u>STEP 2 - Determination of offset</u></h1>

				Now we will use metasploit's tools to get the offset of RIP. Use the following command to generate a pattern of 150 characters and store it in a file called 'output.txt':<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_msf-pattern_create.png" class="responsive">
				</div><br>

				Now start GDB [ or your preferred disassembler ] and load the binary. We will start it with 'output.txt' as our input, and view the register values.<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_reg_values.png" class="responsive">
				</div><br>

				Hmm... well the value in RIP doesn't seem to give us the offset, because in order to get the offset it must contain the hex value of the text in 'output.txt', but '0x401199' [ in my case ] corresponds to 'ï¿½@' therefore it won't give us the offset. However one thing we can notice from the values of all regiters is that RBP [ Base Pointer for the Stack on a x64 machine ] contains hex value '0x3964413864413764' [ in my case ] which seems to be somewhere in the 'output.txt'. Now we will use the value of RBP to determine the offset of RBP.<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_msf-pattern_offset.png" class="responsive">
				</div><br>

				So the offset of RBP seems to be '112'. So according to the layout of the stack in our <a href="../../../../../../../../../Stack Buffer Overflow/x86/x86_redirect_eip.html"><font color=#f44336 face="Fira Code Medium" size="2">previous tutorial</font></a>, the offset of EIP was 4 bytes ahead of the offset of EBP, therefore in case of 64-bit, the offset of RIP is 8 bytes ahead of the offset of RBP. Therefore the offset of RIP is:<br><br>
				[Offset of RBP] + 8 bytes [since registers in x64 machine are of 8 bytes].<br><br>

				So the offset of RIP = [ 112 ] + [ 8 ] = <u><b>120</b></u><br><br>

				Now let's output 120 times 'A' + 4 times 'B' into 'output.txt' and use it as our input and view RIP value using GDB.<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_rip_overwritten_with_BBBB.png" class="responsive">
				</div><br>

				So from the above image it is clear that we can overwrite the RIP, and this also means that the offset we found was absolutely correct.

				<h1><u>STEP 3 - Overwriting EIP and redirect code execution</u></h1>

				For this step we require the address of the 'call_me' function. You can get it from the following command:<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_address_of_call_me.png" class="responsive">
				</div><br>

				Okay now note down this address somewhere [ as it will be different in your case ] and copy the script given below. You can also find it in the resources tab.<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_payload.py_source.png" class="responsive">
				</div><br>

				In the above code replace '0000000000401142' with the address of 'call_me' in your case, and then check the output of the python script.<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_payload.py_output.png" class="responsive">
				</div><br>

				Okay so now our python script should work fine and if we feed this output to 'x64_redirect_eip' we should be able to redirect execution. Let's try it out.<br><br>

				<div id="image">
					<img src="../../../../../../../../../Stack Buffer Overflow/x64/images/x64_redirect_rip_code_execution_redirected.png" class="responsive">
				</div><br>

				PWNED !! Great it worked. So now we are aware about the concepts of overwriting the EIP as well as the RIP. Our next tutorial will be about Aribitrary Code Execution [ ACE ] or Remote Code Execution [ RCE ]. I highly encourage you to practice this technique with your own code.<br><br>

				<div id="align_right">
					Good Luck,<br>
					VulnX
					<br>
				</div>
				<hr class="new5">

			</font>

		</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
var element;
element = document.getElementById("myCookieConsent");

function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

 var cookieVal = getCookie("cookiePromptShown");

if(cookieVal != "Yes") {
	element.style.display = "block";

}
else {
	element.style.display = "none";
}

</script>

	</body>
</html>
